SchemaVersion: 1.0
DataTypes:
  - DataType: Syslog
Type: KQL
Provider: Sentinel
EntitiesFilter: 
 Host_OsFamily:
  - Linux
BaseQuery: |
  //let end = startofday(now());
  //let start = end - 7d;
  let AllUserEvents = (v_Host_Name:string, v_Host_AzureID:string) {
  Syslog
  | where Computer has v_Host_Name or v_Host_AzureID == _ResourceId
  | where Facility == "authpriv"
  | where SyslogMessage has "COMMAND" or ProcessName in~ ("useradd","gpasswd")
  | where SyslogMessage !startswith "omsagent"
  };
  AllUserEvents('{{Host_HostName}}', '{{Host_AzureID}}')
RequiredInputFieldsSets: 
  - - Host_HostName
Insights:
 Id: a9191fbe-ca33-400c-8036-18caac59271c
 DisplayName: Sudo Usage on Host
 Description: |
   Sudo usage on host by users, least events by user, most events by user, new users added, new sudo group members added, new user added to any group
 DefaultTimeRange: 
  BeforeRange: 7d
  AfterRange: 7d
 TableQuery:
  ColumnsDefinitions:
  - Header: Label
    OutputType: String
  - Header: User
    OutputType: String
  - Header: "User Count"
    OutputType: Number
    SupportDeepLink: true
  QueriesDefinitions:

  # MostSudoEventsByUser
  - Filter:    "where SyslogMessage has 'COMMAND' | parse SyslogMessage with User ' ' * | where User != 'omsagent'"
    Summarize: "summarize UserCount = count(User) by User, Computer | top 1 by UserCount desc"
    Project:   "project Title = 'Most Sudo Usage', User = case(isnotempty(User), User, 'None'), UserCount = case(UserCount == 0, 0, UserCount)"

  # LeastSudoEventsByUser
  - Filter:    "where SyslogMessage has 'COMMAND' | parse SyslogMessage with User ' ' * | where User != 'omsagent'"
    Summarize: "summarize UserCount = count(User) by User, Computer | top 1 by UserCount asc"
    Project:   "project Title = 'Least Sudo Usage', User = case(isnotempty(User), User, 'None'), UserCount = case(UserCount == 0, 0, UserCount)"

  # AllSudoEvents
  - Filter:    "where SyslogMessage has 'COMMAND' | parse SyslogMessage with User ' ' * | where User != 'omsagent'"
    Summarize: "summarize UserCount = count(User) by User, Computer | top 1 by UserCount asc"
    Project:   "project Title = 'All Sudo Usage', User = case(UserCount == 1, User, UserCount > 1, 'Many', 'None'), UserCount = case(UserCount == 0, 0, UserCount)"

  # NewUserAdded
  - Filter:    "where ProcessName =~ 'useradd' | where SyslogMessage startswith 'new user:'| parse SyslogMessage with * 'new user: name=' User ', UID=' UID ', GID=' GID ', home=' HomeDir ', shell=' Shell"
    Summarize: "summarize UserCount = dcount(User), UsersAdded = makeset(User) by Computer"
    Project:   "project Title = 'New Users Added', User = case(UserCount == 1, tostring(UsersAdded[0]), UserCount > 1, 'Many', 'None'), UserCount"

  # UsersAddedtoSudoGroup
  - Filter:    "where ProcessName =~ 'gpasswd' | parse SyslogMessage with * 'user ' User ' ' Verb ' by ' AcctMakingChange ' ' Preposition ' group ' Group | project TimeGenerated, Computer, User, Action = strcat(Verb, ' ', Preposition), Group, AcctMakingChange | where Action == 'added to' and Group == 'sudo'"
    Summarize: "summarize UserCount = dcount(User), UsersAdded = makeset(User) by Computer"
    Project:   "project Title = 'Sudo group adds', User = case(UserCount == 1, tostring(UsersAdded[0]), UserCount > 1, 'Many', 'None'), UserCount"

  # UserAddedtoAnyGroup
  - Filter:    "where ProcessName =~ 'gpasswd' | parse SyslogMessage with * 'user ' User ' ' Verb ' by ' AcctMakingChange ' ' Preposition ' group ' Group | project TimeGenerated, Computer, User, Action = strcat(Verb, ' ', Preposition), Group, AcctMakingChange | where Action == 'added to'"
    Summarize: "summarize UserCount = dcount(User), UsersAdded = makeset(User) by Computer"
    Project:   "project Title = 'All group adds', User = case(UserCount == 1, tostring(UsersAdded[0]), UserCount > 1, 'Many', 'None'), UserCount"

 ChartQuery: 
  Title: "Sudo usage over time"
  DataSets: 
   - Query: "parse SyslogMessage with User ' ' * | summarize SudoUsage = count(User) by bin(TimeGenerated, 1h) | extend Legend = 'Count'"
     XColumnName: TimeGenerated
     YColumnName: SudoUsage
     LegendColumnName: Legend
  Type: LineChart
 AdditionalQuery: 
  Text: "See all Sudo usage"
  Query: "parse SyslogMessage with User ' : TTY=' TTY ' PWD=' WorkingDirectory ' USER=' CmdRunAs ' COMMAND=' Commandline | parse Commandline with Command ' ' * | project TimeGenerated, Computer, HostIP, User, CmdRunAs, WorkingDirectory, Command, Commandline, SyslogMessage, _ResourceId"