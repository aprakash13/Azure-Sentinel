SchemaVersion: '1.0'
Type: KQL
Provider: Sentinel
DataTypes:
  - DataType: Syslog
EntitiesFilter: 
 Host_OsFamily:
  - Linux
RequiredInputFieldsSets: 
  - - Host_HostName
BaseQuery: |
  let AllUserEvents = (v_Host_Name:string, v_Host_AzureID:string) {
  Syslog
  | where Computer == v_Host_Name or v_Host_AzureID == _ResourceId
  | where Facility == 'authpriv'
  | where ProcessName in~ ('useradd','userdel')
  | where SyslogMessage startswith 'new user:' or SyslogMessage startswith 'delete user '
  | extend User = case(SyslogMessage startswith 'new user:', tostring(split(tostring(split(SyslogMessage, 'name=')[1]), ',')[0]),
  SyslogMessage startswith 'delete user ', tostring(split(SyslogMessage, "'")[1]),
  'Not Available')
  | extend Action = case( SyslogMessage startswith 'new user', 'new user', SyslogMessage startswith 'delete user', 'delete user', 'None')
  | project TimeGenerated, Computer, HostIP, User, Facility, ProcessName, Action, SyslogMessage, _ResourceId
  | extend timestamp = TimeGenerated, HostCustomEntity = Computer, IPCustomEntity = HostIP, AccountCustomEntity = User
  };
  AllUserEvents('{{Host_HostName}}', '{{Host_AzureID}}')
Insights:
  Id: e7144614-84b3-4884-bc14-cba1b9bac0de
  DisplayName: Linux New or Deleted Users on Host
  Description: |
    'Summary of actions taken by Sudo on the specified host grouped by newly created or deleted users'
  DefaultTimeRange: 
    BeforeRange: 7d
    AfterRange: 7d
  SingleValuesQuery: {}
  TableQuery:
   ColumnsDefinitions:
   - Header: Action
     OutputType: String
   - Header: User
     OutputType: String
   - Header: UserCount
     OutputType: Number
     SupportDeepLink: true
   - Header: ActionCount
     OutputType: Number
     SupportDeepLink: true
   QueriesDefinitions: 
   # UsersCreated
   - Filter:    "where Action == 'new user'"
     Summarize: "summarize UserCount = dcount(User), NewUsers = makeset(User), ActionCount = count() by Computer, Action"
     Project:   "project Action, User = case(UserCount == 1, tostring(NewUsers[0]), UserCount > 1, 'Many', 'None'), UserCount, ActionCount"
   # UsersDeleted
   - Filter:    "where Action == 'delete user'"
     Summarize: "summarize UserCount = dcount(User), DelUsers = makeset(User), ActionCount = count() by Computer, Action"
     Project:   "project Action, User = case(UserCount == 1, tostring(DelUsers[0]), UserCount > 1, 'Many', 'None'), UserCount, ActionCount"

  ChartQuery: 
   Title: "New or Deleted users over time"
   DataSets: 
    - Query: "summarize SudoUsage = count(User) by Time = bin(TimeGenerated, 1h), Action | extend Legend = Action"
      XColumnName: Time
      YColumnName: SudoUsage
      LegendColumnName: Legend
   Type: BarChart
  AdditionalQuery: 
   Text: "See all new or deleted users"
   Query: "project TimeGenerated, Computer, HostIP, User, Facility, ProcessName, Action, SyslogMessage, _ResourceId, timestamp, HostCustomEntity, AccountCustomEntity, IPCustomEntity"

Activities:
 EnabledByDefault: true
 Items:
   - Id: 290032e9-c52e-4e66-841a-7428f0b356bb
     Description: Account created on Host
     Title: "An account was created on this host"
     Content: "On '{{Computer}}' the account '{{User}}' was created by sudo"
     QueryDefinitions:
       Filter: where Action == 'new user'
       SummarizeBy: Computer
   - Id: ce9e87c7-2ffa-42cb-92e5-f1a4f21f007a
     Description: Account deleted on Host
     Title: "An account was deleted on this host"
     Content: "On '{{Computer}}' the account '{{User}}' was deleted by sudo"
     QueryDefinitions:
       Filter: where Action == 'delete user'
       SummarizeBy: Computer