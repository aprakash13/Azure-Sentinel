SchemaVersion: 1.0
Type: KQL
Provider: Sentinel
DataTypes:
  - DataType: SecurityEvent
  - DataType: Event
RequiredInputFieldsSets:
  - - Account_Name
    - Account_NTDomain
  - - Account_SID
BaseQuery: |
  let UserClearedEventLog = (v_Account_Name:string, v_Account_NTDomain:string, v_Account_SID:string){
  SecurityEvent
  // 1102 - This event generates every time Windows Security audit log was cleared
  | where EventID == 1102 and EventSourceName =~ 'Microsoft-Windows-Eventlog'
  | parse EventData with * 'SubjectUserName>' SubjectUserName '<' *
  | parse EventData with * 'SubjectUserSid>' SubjectUserSid '<' * 
  | parse EventData with * 'SubjectLogonId>' SubjectLogonId '<' * 
  | parse EventData with * 'SubjectDomainName>' SubjectDomainName '<' * 
  | parse EventData with * 'BackupPath>' BackupPath'<' * 
  | extend ClearedLog = Type
  | extend Account_Name = SubjectUserName, Account_NTDomain = SubjectDomainName
  | union isfuzzy=true 
  ( Event
  // 104 - This event generates every time a Windows Event log was cleared
  | where EventID == 104 and Source == "Microsoft-Windows-Eventlog"
  | parse EventData with * 'SubjectUserName>' SubjectUserName '<' *
  | parse EventData with * 'SubjectUserSid>' SubjectUserSid '<' * 
  | parse EventData with * 'SubjectLogonId>' SubjectLogonId '<' * 
  | parse EventData with * 'SubjectDomainName>' SubjectDomainName '<' *
  | parse EventData with * 'BackupPath>' BackupPath'<' * 
  | parse RenderedDescription with * 'The' ClearedLog 'log' *
  | extend Account_Name = SubjectUserName, Account_NTDomain = SubjectDomainName, Account_SID = SubjectUserSid
  )
  | project TimeGenerated, Computer, EventID, Account_Name, SubjectUserName, SubjectUserSid, Account_SID, SubjectLogonId, Account_NTDomain, SubjectDomainName, SourceComputerId, _ResourceId, ClearedLog, BackupPath
  | where (Account_Name =~ v_Account_Name and Account_NTDomain =~ v_Account_NTDomain) or (isnotempty(v_Account_SID) and Account_SID =~ v_Account_SID)
  };
  UserClearedEventLog('{{Account_Name}}', '{{Account_NTDomain}}', '{{Account_SID}}')
# The queries for the insights.
Insights:
  Id: 5a70a68d-25d4-4012-b73e-4f302a16c06a
  DisplayName: Event Logs cleared by user
  Description: |
    Provides the datetime & count of number of times any event log was cleared by the user.
  DefaultTimeRange:
    BeforeRange: 12h
    AfterRange: 12h
  TableQuery:
    ColumnsDefinitions:
      - Header: Cleared Log
        OutputType: String
      - Header: Times Cleared
        OutputType: Number
      - Header: Host Count
        OutputType: Number
        SupportDeepLink: true
      - Header: Host(s)
        OutputType: String
    QueriesDefinitions:
    # SecurityEvent cleared
      - Filter: "where ClearedLog =~ 'SecurityEvent'"
        Summarize: "summarize Hosts = makeset(Computer), HostCount = dcount(Computer), EventCount = count() by ClearedLog"
        Project: "project Title = ClearedLog, EventCount, HostCount, Hosts = case(array_length(Hosts) == 1, tostring(Hosts[0]), array_length(Hosts) > 1, 'Many', 'None')"
        LinkColumnsDefinitions:
        - ProjectedName: HostCount
          Query: "{{BaseQuery}} | {{RowFilter}}"
    # Other Event Cleared
      - Filter: "where ClearedLog !~ 'SecurityEvent'"
        Summarize: "summarize Hosts = makeset(Computer), HostCount = dcount(Computer), EventCount = count() by ClearedLog"
        Project: "project Title = ClearedLog, EventCount, HostCount, Hosts = case(array_length(Hosts) == 1, tostring(Hosts[0]), array_length(Hosts) > 1, 'Many', 'None')"
        LinkColumnsDefinitions:
        - ProjectedName: HostCount
          Query: "{{BaseQuery}} | {{RowFilter}}"
  ChartQuery:
    Title: "Log clear activity over time"
    DataSets:
      - Query: "summarize EventCount = count() by bin(TimeGenerated, 1d) | extend Legend = 'EventCount'"
        XColumnName: TimeGenerated
        YColumnName: EventCount
        LegendColumnName: Legend
      - Query: "summarize HostCount = dcount(Computer) by bin(TimeGenerated, 1d) | extend Legend = 'HostCount'"
        XColumnName: TimeGenerated
        YColumnName: HostCount
        LegendColumnName: Legend
    Type: BarChart
  AdditionalQuery:
    Text:  See All Log Clear Activity
    Query: "project TimeGenerated, Computer, EventID, Account_Name, SubjectUserName, SubjectUserSid, SubjectLogonId, Account_NTDomain, SubjectDomainName, SourceComputerId, _ResourceId, ClearedLog, BackupPath"