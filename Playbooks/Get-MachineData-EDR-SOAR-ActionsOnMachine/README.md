# Get-MachineData-EDR-SOAR-ActionsOnMachine
author: Kloudynet Technologies

This Playbook is for sending Microsoft Teams notification when an alert is generated by Defender for endpoint. Teams notifications should also include data about:
-	Machine Vulnerabilities
-	Missing KBs
-	Security Recommendations
-	Alerts
-	Software Inventory

Also should be able to perform some actions like:
-	App Execution
-	Start AV scan

## Prerequisites
1. Defender for Endpoint / MDATP / EDR
2. Microsoft SharePoint online
3. Microsoft Teams
4. Azure AD App registerd with the following permissions under "WindowsDefenderATP"
    - Alert.Read.Add
    - Alert.ReadWrite.All
    - Machine.Read.All
    - Machine.RestrictExecution
    - Machine.Scan
    - SecurityRecommendation.Read.All
    - Software.Read.All
    - Vulnerability.Read.All
5. Azure Keyvault - To store the App Secret of the Azure AD Application

## API Connections
API connections for the above mentioned prerequisites must be created in the resource group in which the resource needs to be created. 

## Setup
1. Create an Azure AD App from Azure AD App Registrations
2. Configure the App API Permissions
    - Refer above permissions mentioned under Prerequisites, point (4)
3. Generate a secret and store it in the Azure Keyvault
4. Edit Playbook Configure connectors
    - Ensure all functions have been configured with their appropriate connectors
    - Setup HTTP connector - Provide the Tenant ID, client/app ID of the app you registered
    - Azure Key Vault - Provide the connection for the Azure Keyvault in which the client secret of the Azure AD App
    - SharePoint connection - To store all the reports
    - Teams connection - To send the notification\
5. Make sure all the API connection values are provided correctly when the template is being deployed in the following format, "```/subscriptions/[subscription]/resourceGroups/SecureLab/providers/Microsoft.Web/connections/[connection_name]```".
6. Deploy the template
7. Once deployment is complete, open the deployed logic app and select the SharePoint site in the "Create new subfolder under Documents to store all csv files" block of the logic app and select "List or Library" as "Documents
8. Make sure to give to same SharePoint site URL given in the above step at the blocks "Create missing KBs csv file", "Create installed software csv file", "Create alerts csv file", "Create recommendation csv file" and "Create vulnerabilities csv file" under the "For each MDATP host - get missing KBs", "For each MDATP host - get software inventory", "For each MDATP host - get alerts", "For each MDATP host - get recommendations" and "For each MDATP host - get vulnerabilities" blocks respectivly.

Optionally, you can always reachout to kloudynetklassrooms@kloudynet.com to get further assistance.
