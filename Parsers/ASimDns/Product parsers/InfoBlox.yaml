Parser:
  Title: InfoBlox
  Version: '0.0'
  LastUpdated: May 10, 2021
Product:
  Name: Infoblox
Normalization:
  Schema: Dns
  Version: '1.0.0'
References:
- Title: Using functions
  Link: https://docs.microsoft.com/azure/azure-monitor/log-query/function
- Title: Dns schema documentation
  Link: https://aka.ms/AzSentinelDnsDoc
Description: |
  This is a Query Parser that is used to map Infoblox NIOX Dns Events (Syslog) to the Azure Sentinel Information Model Dns schema.
ParserName: vimDnsInfobloxNIOS
ParserQuery: |
  let Infoblox=(){
    let RawData = Syslog | where ProcessName == "named" and SyslogMessage has "client"
      | where Computer in ("datasource") and Facility == "local6"
      | extend Parser = extract_all(@"^(\d{2}\-[a-zA-Z]{3}\-\d{4}\s[0-9\.\:]+)?\s?([a-zA-Z-_]+)(\s|\:)?(.*)", dynamic([1,2,3,4]), SyslogMessage)
      | mv-expand todynamic(Parser)
      | extend ResponseTime = todatetime(Parser[0]),
               Log_Type = tostring(Parser[1]),
               RawData_subString = tostring(Parser[3])
      | where Log_Type == "client"
      | project-away Parser;
    RawData 
    | extend dnsdata=tostring(extract_all(@"^(\d{2}\-[a-zA-Z]{3}\-\d{4}\s[0-9\.\:]+)?\s?([a-zA-Z-_]+)(\s|\:)?(.*)", dynamic([1,2,3,4]), SyslogMessage)[0][3])
    | extend EventSubType=iff(dnsdata has "response:", "response", "request")
    | extend dnsclient=iff(EventSubType=='response'
                //<client ip>#port <UDP or TCP>: [view: DNS view] query: <queried domain name> <class name> <type name> response: <rcode> <flags> [<RR in text format>; [<RR in text format>;] ...]
                , extract_all(@'^(\@[a-z0-9]+\s)?([0-9\.]+)\#(\d+):? (UDP|TCP):? (view: DNS view)?query: (\S+) ([A-Z]+) (\S+) response:? ([A-Z]+) (\S+)(([^;]+;\s*)*)',dnsdata)[0]
                //<client IP>#<port> query: <query_Domain name> <class name> <type name> <- or +>[SETDC] <(name server ip)>
                , extract_all(@'^(\@[a-z0-9]+\s)?([0-9\.]+)\#(\d+):? query: (\S+) (\S+) (\S+) ([+-]) \(([0-9.]+)\)',dnsdata)[0])
    | extend
    // ******************* Mandatory
         EventCount=int(1),
         EventStartTime=todatetime(TimeGenerated),
         EventProduct="Infoblox DNS",
         EventVendor="Infoblox",
         EventSchemaVersion="0.0.1",
         Dvc=Computer,
         EventType="lookup", /// ???
        EventResult=iff(EventSubType=='request' or tostring(dnsclient[8])=='NOERROR','Success','Failure'),
         EventResultDetails=iff (EventSubType=='response',tostring(dnsclient[8]),""), // => ResponseCodeNames
         // TimeGenerated, // not handled by schema, but we need to preserve it
         SrcIpAddr = tostring(dnsclient[1]),
         EventSubType=iff(dnsclient has "response:", "response","request"), ///????
        // 
        SrcPortNumber = toint(dnsclient[2]),
        NetworkProtocol = iff (EventSubType=='reaponse', tostring(dnsclient[3]),""),        
        Query = iff (EventSubType=='response',tostring(dnsclient[5]), tostring(dnsclient[3])),
        QueryClassName = iff (EventSubType=='response',tostring(dnsclient[6]),tostring(dnsclient[4])),
        QueryTypeName = iff (EventSubType=='response',tostring(dnsclient[7]),tostring(dnsclient[5])),
        ResponseCodeName = iff (EventSubType=='response',tostring(dnsclient[8]),""),
        Flags =iff (EventSubType=='response', tostring(dnsclient[9]),tostring(dnsclient[6])),
        // 
        EventMessage = iff (EventSubType=='response',tostring(dnsclient[-2]),""),
        DstIpAddr=iff(EventSubType=='response','',dnsclient[-1])
       // **************Aliases
    | extend 
        ResponseCodeName=EventResultDetails, 
        //DomainCategory=UrlCategory,
        Domain=Query,
        IpAddr=SrcIpAddr;
    };
    Infoblox'''