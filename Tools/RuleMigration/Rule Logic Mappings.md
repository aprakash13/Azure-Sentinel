<h1>Sample Rule Mapping between ArcSight/QRadar and Azure Sentinel</h1>
<br />
<h2>ArcSight</h2>
<br />

| <sub>**No.**<sub/> 	|<sub>**Type**<sub/>       	|<sub>**Sample Detection Rule**<sub/>                      	| <sub>**Sample KQL**<sub/> 	|<sub>**Reference**<sub/>      	|
|-----	|--------------	|---------------------------------------------	|------------	|----------------	|
|<sub>1. <sub/>  	|<sub>**Filter** (and)<sub/>| <img src="media/caf5e11a5e0d7ed6dcc675c0caaaf7aa.png"> 	| <br/><pre><sub>SecurityEvent<br/>\| where EventID == 4728<br/>\| where SubjectUserName =~ "AutoMatedService"<br/>\| where isnotempty(SubjectDomainName)</sub></pre><sub> This assumes that the Windows Security Events are collected via MMA/AMA.<br/>Hence, we are using SecurityEvent table in Azure Sentinel.<br/><br/>**Note:** <br/> - Avoid case-insensitive operators (=~) when possible for query optimization. <br/> - Use (==) if the value is not case-sensitive.<br/> - Order the filters by starting with the 'where' statement that filter out the most data.<br/><br/></sub> | <sub>- [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>- [Numerical Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/numoperators)<br/>- [ago](https://docs.microsoft.com/azure/data-explorer/kusto/query/agofunction)<br/>- [Datetime](https://docs.microsoft.com/azure/data-explorer/kusto/query/datetime-timespan-arithmetic)<br/>- [between](https://docs.microsoft.com/azure/data-explorer/kusto/query/betweenoperator)<br/>- [now](https://docs.microsoft.com/azure/data-explorer/kusto/query/nowfunction)<br/>- [parse](https://docs.microsoft.com/azure/data-explorer/kusto/query/parseoperator)<br/>- [extract](https://docs.microsoft.com/azure/data-explorer/kusto/query/extractfunction)<br/>- [parse_json](https://docs.microsoft.com/azure/data-explorer/kusto/query/parsejsonfunction)<br/>- [parse_csv](https://docs.microsoft.com/azure/data-explorer/kusto/query/parsecsvfunction)<br/>- [parse_path](https://docs.microsoft.com/azure/data-explorer/kusto/query/parsepathfunction)<br/>- [parse_url](https://docs.microsoft.com/azure/data-explorer/kusto/query/parseurlfunction) </sub>	
|<sub>2.<sub/>    | <sub>**Filter** (or) <sub/> | <img src="media/cf7c4ef2bf29e136988353de1355bec2.png">  |<sub>***Option 1: Use 'in'***<br/><pre>SecurityEvent<br/>\| where SubjectUserName in<br/> ("Adm1","ServiceAccount1","AutomationServices")</pre><br/>***Option 2: Use 'or'***<br/><pre>SecurityEvent<br/>\| where SubjectUserName == "Adm1" or <br/>SubjectUserName == "ServiceAccount1" or <br/>SubjectUserName == "AutomationServices"</pre>***Note:***<br/>Both options are identical in performance, but Option 1 is preferred as it is more user-readable.<br/><br/></sub> | <sub>- [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>- [in](https://docs.microsoft.com/azure/data-explorer/kusto/query/inoperator) </sub> 
|<sub>3.<sub/>   | <sub>**Nested Filter**<sub/>  |  ![](media/e287eb056812ee240fe572a28d809393.png)<br/><br/><br/><sub>__"/All Filters/Soc Filters/Exclude Valid Users":__<br/><br/><sub/>  ![](media/86656cdcececce6b6c45d4db3f8b15e1.png) | <sub>***Option 1: Direct filter with "where" statement***<br/><br/><pre>SecurityEvent<br/>\| where EventID == 4728 <br/>\| where isnotempty(SubjectDomainName) or <br/>isnotempty(TargetDomainName) <br/>\| where SubjectUserName !\~ "AutoMatedService"</pre><br/><br/>***Option 2: Use KQL function***<br/><br/>  1. Save the following query as KQL function with the alias of "ExcludeValidUsers".<br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService"<br/>\| project SubjectUserName</pre>2. After that, use the following query to filter "ExcludeValidUsers"<br/><pre>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) or <br/>isnotempty(TargetDomainName)<br/>\| where SubjectUserName !in (ExcludeValidUsers)</pre><br/>***Option 3: Use parameter function***<br/><br/> 1. Create a parameter function with the name and alias of “ExcludeValidUsers”.<br/>  2. Define the parameters of the function. For example,<br/><pre>Tbl: (TimeGenerated:datatime, Computer:string, <br/>EventID:string, SubjectDomainName:string, <br/>TargetDomainName:string, SubjectUserName:string)</pre>  3. The parameter function has the following query:<pre>Tbl<br/>\| where SubjectUserName !\~ "AutoMatedService"</pre> 4. Invoke the parameter function with the following query:<br/> <pre>let Events = (<br/>SecurityEvent <br/>\| where EventID == 4728<br/>);<br/>ExcludeValidUsers(Events)</pre><br/>***Option 4: Use Join***<br/><br/>Least preferred option. Avoid using 'join' when it can be done with other options.<br/><pre>let events = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName) <br/>or isnotempty(TargetDomainName)<br/>);<br/>let ExcludeValidUsers = (<br/>SecurityEvent<br/>\| where EventID == 4728<br/>\| where isnotempty(SubjectDomainName)<br/>\| where SubjectUserName =\~ "AutoMatedService"<br/>);<br/>events<br/>\| join kind=leftanti ExcludeValidUsers on <br>\$left.SubjectUserName == \$right.SubjectUserName</pre><br/>***Note:***<br/>- Avoid case-insensitive operators (=\~ and !\~) when possible for query optimization. Use (== and !=) if the value is not case-sensitive.<br/>- Option 1 is preferred due to its simplicity while Option 4 is the least preferred option. Avoid using 'join' when it can be done with other options for better performance.<br/><br/><sub/> |<sub>-   [Sample KQL function.](https://techcommunity.microsoft.com/t5/azure-sentinel/using-kql-functions-to-speed-up-analysis-in-azure-sentinel/ba-p/712381)<br/>- [Sample Parameter function.](../../../Downloads/Enriching%20Windows%20Security%20Events%20with%20Parameterized%20Function%20-%20Microsoft%20Tech%20Community)<br/>- [Join](https://docs.microsoft.com/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>- [where](https://docs.microsoft.com/azure/data-explorer/kusto/query/whereoperator)</sub>
|<sub>4.<sub/>   | <sub>**Active list**  (Lookup)<sub/>   | ![](media/513a09f2398d9c89d3c7499f0f54856e.png)   |<sub>This assumes the Watchlist 'Cyber-Ark Exception Accounts' has been created in Azure Sentinel with an 'Account' field.<br/><br/><pre>let Activelist=(<br/>\_GetWatchlist('Cyber-Ark Exception Accounts')<br/>\| project Account );<br/>CommonSecurityLog<br/>\| where DestinationUserName in (Activelist)<br/>\| where DeviceVendor == "Cyber-Ark"<br/>\| where DeviceAction == "Get File Request"<br/>\| where DeviceCustomNumber1 != ""<br/>\| project DeviceAction, DestinationUserName, <br/>TimeGenerated,SourceHostName, <br/>SourceUserName, DeviceEventClassID</pre>**Note:**<br/>Order the filters by starting with the 'where' statement that filter out the most data.<br/><sub/>| <sub>Watchlist is the "Active list" equivalent feature in Azure Sentinel.<br/>Learn more about Watchlist with the following link:<br/>- [Watchlist](https://docs.microsoft.com/azure/sentinel/watchlists)<br/><br/>Watchlist is just one of the methods to implement lookups.<br/>Refer to the below blog post for more options:<br/>- [Implementing Lookups in Azure Sentinel](https://techcommunity.microsoft.com/t5/azure-sentinel/implementing-lookups-in-azure-sentinel/ba-p/1091306)<sub/>  
|<sub>5.<sub/>  | <sub>**Correlation** <br/>(Match a rule condition against a set of base events)<sub/> |  ![](media/7328be18fb4d82d41dcf5856b7cde57b4.png) | <sub><pre>let event1 =(<br/>SecurityEvent<br/>\| where EventID == 4728<br/>);<br/>let event2 =(<br/>SecurityEvent<br/>\| where EventID == 4729<br/>);<br/>event1<br/>\| join kind=inner event2 <br/>on \$left.TargetUserName==\$right.TargetUserName</pre>**Note:**<br/>For optimization, make sure the smaller table is on the left side of the join. Also, if the left side is relatively small (up to 100K records), add `hint.strategy=broadcast` for better performance.<sub/> | <sub>Join:<br/>- [Join](https://docs.microsoft.com/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>- [Time Window Join](https://docs.microsoft.com/azure/data-explorer/kusto/query/join-timewindow)<br/>- [Shuffle](https://docs.microsoft.com/azure/data-explorer/kusto/query/shufflequery)<br/>- [Broadcast](https://docs.microsoft.com/azure/data-explorer/kusto/query/broadcastjoin)<br/>- [Union](https://docs.microsoft.com/azure/data-explorer/kusto/query/unionoperator?pivots=azuredataexplorer)<br/><br/>Define statement:<br/>- [let](https://docs.microsoft.com/azure/data-explorer/kusto/query/letstatement)<br/><br/> Aggregation:<br/>- [make_set](https://docs.microsoft.com/azure/data-explorer/kusto/query/makeset-aggfunction)<br/>- [make_list](https://docs.microsoft.com/azure/data-explorer/kusto/query/makelist-aggfunction)<br/>- [make_bag](https://docs.microsoft.com/azure/data-explorer/kusto/query/make-bag-aggfunction)<br/>- [pack](https://docs.microsoft.com/azure/data-explorer/kusto/query/packfunction)<sub/>  
|<sub>6.<sub/>  | <sub>**Correlation** (Time Window Filter)<sub/>  |  ![](media/765de18fb4d82d41dcf5856b7cde57b4.png) |<sub><pre>let waittime = 10m;<br/>let lookback = 1d;<br/>let event1 = (<br/>SecurityEvent<br/>\| where TimeGenerated \> ago(waittime+lookback)<br/>\| where EventID == 4728<br/>\| project event1_time = TimeGenerated, <br/>event1_ID = EventID, event1_Activity= Activity, <br/>event1_Host = Computer, TargetUserName, <br/>event1_UPN=UserPrincipalName, <br/>AccountUsedToAdd = SubjectUserName <br/>);<br/>let event2 = (<br/>SecurityEvent<br/>\| where TimeGenerated \> ago(waittime)<br/>\| where EventID == 4729<br/>\| project event2_time = TimeGenerated, <br/>event2_ID = EventID, event2_Activity= Activity, <br/>event2_Host= Computer, TargetUserName, <br/>event2_UPN=UserPrincipalName,<br/> AccountUsedToRemove = SubjectUserName <br/>);<br/> event1<br/>\| join kind=inner event2 on TargetUserName<br/>\| where event2_time - event1_time \< lookback<br/>\| where tolong(event2_time - event1_time ) \>=0<br/>\| project delta_time = event2_time - event1_time,<br/> event1_time, event2_time,<br/> event1_ID,event2_ID,event1_Activity,<br/> event2_Activity, TargetUserName, AccountUsedToAdd,<br/> AccountUsedToRemove,event1_Host,event2_Host, <br/> event1_UPN,event2_UPN</pre><sub/>|<sub>- [Join](https://docs.microsoft.com/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>- [Azure Sentinel Correlation Rules : Join](https://techcommunity.microsoft.com/t5/azure-sentinel/azure-sentinel-correlation-rules-the-join-kql-operator/ba-p/1041500)<sub/>
|<sub>7.<sub/>  | <sub>**Aggregation**<sub/>  | ![](media/b3a52d1e5d3ef4a33a0504f94f9bf7cc.png) | <sub><pre>SecurityEvent<br/>\| summarize Count = count() by SubjectUserName, <br/>SubjectDomainName<br/>\| where Count \>3</pre><sub/> |<sub>- [summarize](https://docs.microsoft.com/azure/data-explorer/kusto/query/summarizeoperator)<sub/>
  
<br />
<br />
<br />
<br />
<h2>QRadar</h2>
<br />

| <sub>**No.**<sub/> 	|<sub>**Type**<sub/>       	|<sub>**Sample Detection Rule**<sub/>                      	| <sub>**Sample KQL**<sub/> 	|<sub>**Reference**<sub/>      	|
|-----	|--------------	|---------------------------------------------	|------------	|----------------	|
|<sub>1.<sub/> | <sub>**Common Property Tests**<sub/>  |<sub> Syntax:<sub/>![](media/589476c0a854f3a5987dec7782889b46.png) | <sub>See below for each statement separately:<sub/> | |
| | | <sub>and when any of **\<these properties\>** match **\<this regular expression\>**</br>Example:<sub/> ![](media/770315e174bd4d5a77c86448776ff601.png) |<sub><pre>CommonSecurityLog</br>\| where tostring(SourcePort)<br/> matches regex @"\\d{1,5}" <br/>or tostring(DestinationPort) <br/>matches regex @"\\d{1,5}"</pre><sub/>|<sub>- [matches</br>regex](https://docs.microsoft.com/azure/data-explorer/kusto/query/re2)<sub/>|
| | | <sub>and when the event matches \<**this\>** AQL filter query</br>Example:<sub/> ![](media/c34f274ca7e8b036e98e61740590f526.png) |<sub><pre>CommonSecurityLog</br>\| where SourceIP == '10.1.1.10'</pre><sub/>|<sub>-  [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<sub/>  |
| |  | <sub>and when **\<this property\> \<equals/not equals\> \<this property\>**</br>Example:<sub/> ![](media/84e4e93c43d7123662b6d99c9fbbbc1c.png) |<sub><pre>CommonSecurityLog</br>\| where SourceIP == DestinationIP</pre><sub/> |<sub>-  [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<sub/>
|<sub>2.<sub/> | <sub>**Date/Time Tests**<sub/>  |<sub>Syntax:<sub/> ![](media/99aad65913131b01281b263c1f09d942.png) | <sub>See below for each statement separately:<sub/> |<sub>-  [Date/time operations](https://docs.microsoft.com/azure/data-explorer/kusto/query/samples?pivots=azuremonitor#date-and-time-operations)<sub/>   |
| | | <sub>and when the event(s) occur \<**on/after/before\>** the \<**selected\>** day of the month</br>Example:<sub/> ![](media/94a7113e83b467298b5a045bc071f49e.png) |<sub><pre>SecurityEvent</br>\| where dayofmonth(TimeGenerated)\<4</pre><sub/>|<sub>-  [dayofmonth()](https://docs.microsoft.com/azure/data-explorer/kusto/query/dayofmonthfunction)<sub/> |
| | |<sub> and when the event(s) occur on any of \<**these days of the week{Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday}**\></br>Example:<sub/> ![](media/5aa6f1449a63b4e1389f5c7856463e41.png)                                                                                                                                                | <sub><pre>SecurityEvent</br>\| where dayofweek(TimeGenerated)</br>between (3d .. 5d)</pre><sub/>|<sub>-  [dayofweek()](https://docs.microsoft.com/azure/data-explorer/kusto/query/dayofweekfunction)<sub/> |
|  | | <sub>and when the event(s) occur \<**after/before/at\> \<this time{12.00AM, 12.05AM, ...11.50PM, 11.55PM}**\></br>Example:<sub/> ![](media/bbc348f1e04c0edab4b4548ff039643e.png)  |<sub><pre>SecurityEvent</br>\| where format_datetime(TimeGenerated,</br>'HH:mm')=="23:55"</pre> **Note:** TimeGenerated is in UTC/GMT<sub/>  |<sub>- [format_</br>datetime](https://docs.microsoft.com/azure/data-explorer/kusto/query/format-datetimefunction) <sub/>
|<sub>3.<sub/> | <sub>**Event property Tests**<sub/>  | ![](media/42c406f899f89708cf98722756821192.png)  | <sub>See below for each statement separately:<sub/>  | |
| | | <sub> and when the IP protocol is one of the following **\<protocols\>**</br>Example:<sub/> ![](media/21fae36240a914cfbdda8f8760017c6a.png)|<sub><pre>CommonSecurityLog</br>\| where Protocol in ("UDP","ICMP")</pre><sub/>|<sub>-  [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<sub/>|
| | |<sub> and when the Event Payload contains **\<this string**\></br>Example:![](media/d9c4307d45781276cfca8101fa1620dd.png)<sub/> |<sub><pre>CommonSecurityLog</br>\| where DeviceVendor has "Palo Alto"</pre>**Note:**</br>Avoid using "[search()](https://docs.microsoft.com/azure/data-explorer/kusto/query/searchoperator?pivots=azuredataexplorer)" command if you already know the table name as it is not performance optimized. <sub/> |<sub>-  [has](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators)<sub/>
|<sub>4.<sub/> |<sub>**Functions - Counters**<sub/> | ![](media/ad948f1a7cd75d534888d2c4dae261a4.png)  | <sub>See below for each statement separately:<sub/> | |
| | | <sub> and when at least **\<this many\>** events are seen with the same **\<event properties\>** in **\<this many\> \<minutes\>**</br>Example: ![](media/27530cfda836607ae0e417549db02985.png)<sub/>                                                                                                                                                                 |<sub><pre>CommonSecurityLog</br>\| summarize Count = count() <br/>by SourceIP, DestinationIP</br>\| where Count \>= 5</pre><sub/>|<sub>-  [summarize](https://docs.microsoft.com/azure/data-explorer/kusto/query/summarizeoperator)<sub/>
|<sub>5.<sub/> |<sub>**Functions - Negative**<sub/> | ![](media/84b0592bde1b9d5090e4a5fa8316c419.png) | <sub>See below for each statement separately:<sub/>  |   |
|  |  | <sub>and when none of **\<these rules\>** match in **\<this many\> \<minutes\>** after **\<these rules\>** match with the same **\<event properties\>**</br>Example:  ![](media/21fae36240a914cfbdda8f8760017c6a.png) ![](media/84e4e93c43d7123662b6d99c9fbbbc1c.png) Example using the rules defined above: ![](media/bf171f333debe3bd056b8fec05e8ecb1.png)<sub/>   |<sub><pre>let spanoftime = 10m;</br>let Test2 = (</br> CommonSecurityLog</br>\| where Protocol !in ("UDP","ICMP")</br>\| where TimeGenerated \></br>ago(spanoftime)</br>);</br>let Test6 = (</br> CommonSecurityLog</br>\| where SourceIP == DestinationIP</br>);</br>Test2</br>\| join kind=rightanti Test6 on </br>\$left.SourceIP == \$right.SourceIP </br>and \$left.Protocol ==\$right.Protocol</pre><sub>|<sub>-  [join()](https://docs.microsoft.com/azure/data-explorer/kusto/query/joinoperator?pivots=azuredataexplorer)<br/>- [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<br/>- [Numerical Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/numoperators)<sub/>
|<sub>6.<sub/> |<sub>**Functions – Simple**<sub/>  | ![](media/b4827844bee9f5c1b514799c54c9f360.png)  |<sub>See below for each statement separately:<sub/> |  |
| || <sub>and when an event matches **\<any\|all\>** of the following **\<rules\>**</br>Example: ![](media/7198293ebb9c16d7e7de669e31c9cc8f.png)<sub/> |<sub><pre>CommonSecurityLog</br>\| where Protocol !in ("UDP","ICMP") </br>or SourceIP == DestinationIP</pre><sub/>|<sub>-  [or](https://docs.microsoft.com/azure/data-explorer/kusto/query/logicaloperators)<sub/>
|<sub>7.<sub/> |<sub>**IP / Port Tests**<sub/> | ![](media/9298713f8003d7b3d332fc4ef8a2c25b.png) |<sub>See below for each statement separately:<sub/> |  |
|  |   | <sub>and when the source port is one of the following **\<ports\>**</br>Example: ![](media/7bf452a3eeda48d4bc8fc940e71c6974.png)<sub/> |<sub><pre>CommonSecurityLog</br>\| where SourcePort == 20</pre><sub/>|<sub>-  [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<sub/>|
|  |  | <sub>and when the source IP is one of the following **\<IP addresses\>**</br>Example: ![](media/218eebd9f180df1da02c4da26b50cb35.png)<sub/> |<sub><pre>CommonSecurityLog</br>\| where SourceIP in</br>("10.1.1.1","10.2.2.2")</pre><sub/>|<sub>-  [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<sub/>
|<sub>8.<sub/> |<sub>**Log Source Tests**<sub/> | ![](media/0e63f550fffa8b9694251eb38d6ac574.png) |<sub>See below for each statement separately:<sub/> | |
| |  | <sub>and when the event(s) were detected by one or more of these **\<log source types\>**</br>Example:  ![](media/d816b66c464f4cc3574e3a3c04bc7965.jpeg)<sub/> |  <sub><pre>OfficeActivity</br>\| where OfficeWorkload == "Exchange"</pre><sub/>|<sub>-  [String Operators](https://docs.microsoft.com/azure/data-explorer/kusto/query/datatypes-string-operators#operators-on-strings)<sub/>
